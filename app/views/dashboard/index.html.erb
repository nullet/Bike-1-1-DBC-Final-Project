<%= render 'users/nav' %>

<h1>Welcome to Bike-1-1</h1>

<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

<style type="text/css">
  html { height: 80% }
  body { height: 100%; margin: 0; padding: 0 }
  #map-canvas { height: 100% }
</style>

<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script>


<script type="text/javascript">
  var map, infowindow;

  function initialize() {
    // var userLatLng = new google.maps.LatLng(41.889616, -87.637211)
    var userLatLng = new google.maps.LatLng(<%= current_user.hb_latitude %>, <%= current_user.hb_longitude %>)

    map = new google.maps.Map(document.getElementById( "map-canvas"), {
      center: userLatLng,
      zoom: 16
    });

    var request = {
      location: userLatLng,
      radius: 5000,
      keyword: "bike shops"
    }

    infowindow = new google.maps.InfoWindow();
    var service = new google.maps.places.PlacesService(map);
    service.nearbySearch(request, callback);
    
    // Creates Marker Text for Current User Pin
    createMarker(userLatLng, "<h3>You are here</h3>", 'yellow');

    // Adds Bike Routes to Map -- DON'T DELETE
    // var bikeLayer = new google.maps.BicyclingLayer();
    // bikeLayer.setMap(map);

    // Creates Markers (Pins) for All Current Events
    <% @events.each do |event| %>
      <% if event.created_at < 1.minute.ago && event.active == true %>
        var map_event = new google.maps.LatLng(<%= event.latitude %>, <%= event.longitude %>)

        createMarker(map_event, "<h3><%= event.requester.first_name %></h3><p>Karma Points: <%= event.requester.karma_count %></p><p><%= event.request_text %></p>", 'red');
      <%end%>
    <%end%>

    // // Re-center Map:
    // google.maps.event.addListener(map, 'center_changed', function() {
    // // 3 seconds after the center of the map has changed, pan back to the
    // // marker.
    //   window.setTimeout(function() {
    //     map.panTo(marker.getPosition());
    //   }, 3000);
    // });

  } // end initialize()


  // var image = '../../assets/images/chibluebike.png';
  
  // Creates Markers for Events (Help Requests):
  function createMarker(location, content, color) {
  //    var image = 
  //     // url: 
  //     '../../assets/images/chibluebike.png'
  //     // size: new google.maps.Size(20, 32),
  //     // origin: new google.maps.Point(0,0),
  //     // anchor: new google.maps.Point(0, 32)
  //   ;

    // var placeLoc = place.geometry.location;
    var image = { 
                  url: "/assets/" + color + "bike.png",
                  scaledSize: new google.maps.Size(25, 25)
    };
// console.log(location);
    var marker = new google.maps.Marker({
      map: map,
      position: location,
      icon: image
      // position: place.geometry.location
    });

    google.maps.event.addListener(marker, 'click', function() {
      infowindow.setContent(content);
      infowindow.open(map, this);
    });

  }

  // Creates Place (Bike Shop) Markers:
  function callback(results, status) {
    if (status == google.maps.places.PlacesServiceStatus.OK) {
      for (var i = 0; i < results.length; i++) {
        var open,
            place = results[i]
        // if (place.opening_hours.open_now){open = "Currently Open"}
        // else {open = "Currently Closed"}

        var content = '<div class="bike_shop">' +
      '<h3 id="firstHeading">' + place.name + '</h3>'+
      '<div id="bodyContent">'+ '<p>' + open + '</p>' + '<p>Rating: ' + place.rating + '</p>' + '</p>' + '<p>Phone: ' + place.formatted_phone_number + '</p>' + '<p>Address: ' + place.formatted_address + '</p>' +'</div>'

        createMarker(place.geometry.location, content, 'blue');
      }
    }
  }

  google.maps.event.addDomListener(window, 'load', initialize);

</script>

<div style='width: 900px'>
  <div id="map-canvas" style="width: 100%; height: 650px;"/>
</div>

<!-- <div style='width: 350px'>
  <div id="event-detail"/>
</div> -->